<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>SPI flash support in embedded Linux box</title>
  <meta name="description" content="Serial Peripheral Interface (SPI) flash memory is often used in an embedded Linux box to hold bootloader. During very initial board bringup, SPI flash memory...">
  
  <meta name="author" content="Wenwei Weng">
  <meta name="copyright" content="&copy; Wenwei Weng 2023">
  

  <!-- External libraries -->
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css">
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/styles/monokai-sublime.min.css">
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/lightbox2/2.7.1/css/lightbox.css">

  <!-- Favicon and other icons (made with http://www.favicon-generator.org/) -->
  <link rel="shortcut icon" href="/assets/icons/favicon.ico" type="image/x-icon">
  <link rel="icon" href="/assets/icons/favicon.ico" type="image/x-icon">
  <link rel="apple-touch-icon" sizes="57x57" href="/assets/icons/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/assets/icons/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/assets/icons/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/assets/icons/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/assets/icons/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/assets/icons/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/assets/icons/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/assets/icons/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/assets/icons/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192"  href="/assets/icons/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/icons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/assets/icons/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/assets/icons/favicon-16x16.png">
  <link rel="manifest" href="/assets/icons/manifest.json">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="/assets/icons/ms-icon-144x144.png">
  <meta name="theme-color" content="#ffffff">

  

  

  

  <!-- Site styles -->
  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="http://localhost:4000/linux/2017/08/05/SPI-Support-embedded-box.html">
	<link rel="alternate" type="application/rss+xml" title="Wenwei Weng's Blog" href="http://localhost:4000/feed.xml" />
	
	<!-- Tooltips -->
	<script type="text/javascript">
		window.tooltips = []
	</script>
</head>


  <body>

    <header class="navigation" role="banner">
  <div class="navigation-wrapper">
    <a href="/" class="logo">
      
      <img src="/assets/avatar.png" alt="Wenwei Weng's Blog">
      
    </a>
    <a href="javascript:void(0)" class="navigation-menu-button" id="js-mobile-menu">
      <i class="fa fa-bars"></i>
    </a>
    <nav role="navigation">
      <ul id="js-navigation-menu" class="navigation-menu show">
				
	
	<li class="nav-link"><a href="/about/">About</a>
	

	

	

	
	<li class="nav-link"><a href="/posts/">Posts</a>
	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	


      </ul>
    </nav>
  </div>
</header>


    <div class="page-content">
        <div class="post">

<div class="post-header-container " >
  <div class="scrim ">
    <header class="post-header">
      <h1 class="title">SPI flash support in embedded Linux box</h1>
      <p class="info">by <strong>Wenwei Weng</strong></p>
    </header>
  </div>
</div>

<div class="wrapper">

 <span class="page-divider">
  <span class="one"></span>
  <span class="two"></span>
</span>
 

<section class="post-meta">
  <div class="post-date">August 5, 2017</div>
  <div class="post-categories">
  in 
    
    <a href="/category/Linux">Linux</a>
    
  
  </div>
</section>

<article class="post-content">
  <p>Serial Peripheral Interface (SPI) flash memory is often used in an embedded Linux box to hold bootloader. During very initial board bringup, SPI flash memory needs to be programmed properly using device like Dediprog, otherwise the box won’t boot. After the box is up running linux, often there is need to access SPI flash, e.g. upgrade new version of bootloader from linux. I will share what needs to be done for that.</p>

<p><img src="/uploads/linux/linux-spi.jpg" alt="Linux SPI" /></p>

<!--more-->
<h2 id="spi-flash-hardware-overview">SPI Flash: hardware overview</h2>
<p>There are many flash memory devices in the market, often people see USB flash memory, SD card. Those flash memory are parallel flash, eithe NOR or NAND flash. With parell access, the throughput is a lot higher. SPI flash is accessed in a serial way, so it is much slower.</p>

<p>SPI devices communicate in full duplex mode using a master-slave architecture with a single master. The master device originates the frame for reading and writing. Multiple slave devices are supported through selection with individual slave select (SS) lines.</p>

<p><img src="/uploads/linux/spi-master-slave.png" alt="SPI Master Slaves" /></p>

<p>SCK: Serial Clock  MOSI: Master Output Slave Input   MISO: Master Input Slave Output  SS: Slave Select</p>

<p>SPI Master often is provided by SoC, SPI flash device serves as SPI slave.</p>

<h2 id="what-are-needed-to-enable-spi-flash-access-from-linux-">What are needed to enable SPI flash access from Linux ?</h2>
<p>There are three areas to do in order to enable SPI flash access from Linux user space.</p>

<h3 id="enable-spi-controller-in-device-tree">Enable SPI controller in device tree.</h3>

<p>In my case, Marvell ARMADA 7040 SoC has SPI controller provided, I need do the following:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">bash-4.3# <span class="nb">cat </span>armada-7040-db.dts
...
                        spi@700680 <span class="o">{</span>
                                compatible <span class="o">=</span> <span class="s2">"marvell,armada-380-spi"</span><span class="p">;</span>
                                reg <span class="o">=</span> &lt;0x700680 0x50&gt;<span class="p">;</span>
                                <span class="c">#address-cells = &lt;0x1&gt;;</span>
                                <span class="c">#size-cells = &lt;0x0&gt;;</span>
                                cell-index <span class="o">=</span> &lt;0x2&gt;<span class="p">;</span>
                                clocks <span class="o">=</span> &lt;0x26 0x1 0x15&gt;<span class="p">;</span>
                                status <span class="o">=</span> “okay<span class="s2">";

                                spi-flash@0 {
                                        #address-cells = &lt;0x1&gt;;
                                        #size-cells = &lt;0x1&gt;;
                                        compatible = "</span>jedec,spi-nor<span class="s2">";
                                        reg = &lt;0x0&gt;;
                                        spi-max-frequency = &lt;0x1312d00&gt;;

                                        partition@0 {
                                                label = "</span>boot<span class="s2">";
                                                reg = &lt;0x0 0x200000&gt;;
                                        };

                                        partition@200000 {
                                                label = "</span>Filesystem<span class="s2">";
                                                reg = &lt;0x200000 0xd00000&gt;;
                                        };

                                        partition@d00000 {
                                                label = "</span>boot_2nd<span class="s2">";
                                                reg = &lt;0xf00000 0x100000&gt;;
                                        };
                                };
                        };
...</span></code></pre></figure>

<p>From the above, DTS defined the SPI flash to have three partitions: “boot”, “Filesystem” and “boot_2nd”. We will see how this definition is manifested in linux system.</p>

<p>Integrate the dtb file into linux boot in a proper way depending your situation.</p>

<h3 id="enable-proper-kernel-drivers-for-spi">Enable proper kernel drivers for SPI</h3>

<p>Linux kernel has done a lot work to support SPI flash so that user space can access SPI flash easily. It has following architecture:</p>

<p><img src="/uploads/linux/linux-spi-mtd-fs.jpg" alt="Linux SPI SW arch" /></p>

<p>To enable SPI access, the following kernel configurations are required:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">bash-4.3# <span class="nb">cat</span> .config
...
<span class="nv">CONFIG_MTD</span><span class="o">=</span>y
<span class="nv">CONFIG_MTD_BLKDEVS</span><span class="o">=</span>y
<span class="nv">CONFIG_MTD_BLOCK</span><span class="o">=</span>y
<span class="nv">CONFIG_MTD_M25P80</span><span class="o">=</span>y
<span class="nv">CONFIG_MTD_SPI_NOR</span><span class="o">=</span>y
<span class="nv">CONFIG_MTD_SPI_NOR_USE_4K_SECTORS</span><span class="o">=</span>y
...
<span class="nv">CONFIG_SPI</span><span class="o">=</span>y
<span class="nv">CONFIG_SPI_MASTER</span><span class="o">=</span>y
<span class="nv">CONFIG_SPI_ARMADA_3700</span><span class="o">=</span>y
...</code></pre></figure>

<h3 id="access-from-user-space">Access from user space</h3>
<p>With the changes in DTS and kernel, after linux boots, the below will be observed in kernel space:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"> 
bash# dmesg
.......
<span class="o">[</span>    4.110288] m25p80 spi2.0: n25q128a13 <span class="o">(</span>16384 Kbytes<span class="o">)</span>
<span class="o">[</span>    4.115301] 3 ofpart partitions found on MTD device spi2.0
<span class="o">[</span>    4.120815] Creating 3 MTD partitions on <span class="s2">"spi2.0"</span>:
<span class="o">[</span>    4.125632] 0x000000000000-0x000000200000 : <span class="s2">"boot"</span>
<span class="o">[</span>    4.130895] 0x000000200000-0x000000f00000 : <span class="s2">"Filesystem"</span>
<span class="o">[</span>    4.136619] 0x000000f00000-0x000001000000 : <span class="s2">"boot_2nd"</span>
.......</code></pre></figure>

<p>From the user space, the first thing can be seen is the mtd device files:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"> 
bash#  <span class="nb">ls</span> <span class="nt">-l</span> /dev/mtd<span class="k">*</span>
crw------- 1 root root 90, 0 Feb  6 08:14 /dev/mtd0
crw------- 1 root root 90, 1 Feb  6 08:14 /dev/mtd0ro
crw------- 1 root root 90, 2 Feb  6 08:14 /dev/mtd1
crw------- 1 root root 90, 3 Feb  6 08:14 /dev/mtd1ro
crw------- 1 root root 90, 4 Feb  6 08:14 /dev/mtd2
crw------- 1 root root 90, 5 Feb  6 08:14 /dev/mtd2ro
brw------- 1 root disk 31, 0 Feb  6 08:14 /dev/mtdblock0
brw------- 1 root disk 31, 1 Feb  6 08:14 /dev/mtdblock1
brw------- 1 root disk 31, 2 Feb  6 08:14 /dev/mtdblock2</code></pre></figure>

<p>/dev/mtdblock0 is for “boot” (first bootloader) partition; 
/dev/mtdblock1 is for “FileSystem” partition;
/dev/mtdblock2 is for “boot_2nd” partition.</p>

<p>what can we do now? Life is easy with all these infrastructure in place.</p>
<ul>
<li> To program a new version bootloader, simply: dd if=new-bootloader.bin of=/dev/mtdblock0 </li>
<li> If we want to use partition as file system, simply: </li>
     <ul>
     <li>mkdir /mnt/spi </li>
     <li>mkfs.jffs2 /dev/mtdblock1 </li>
     <li>mount -t jfss2 /dev/mtdblock1 /mnt/spi </li>
     </ul>
</ul>

<p>Life is good!</p>

<p>References:</p>
<ul>
<li> http://free-electrons.com/blog/managing-flash-storage-with-linux/ </li>
<li> http://slideplayer.com/slide/10452504/ </li>
</ul>


</article>





<section class="rss">
  <p class="rss-subscribe text"><strong>Subscribe <a href="/feed.xml">via RSS</a></strong></p>
</section>

<section class="share">
  <span>Share: </span>
  
    
    
    
    
    
    
    
    
  
    
    
    
    
    
      <a href="//www.linkedin.com/shareArticle?mini=true&url=http%3A%2F%2Flocalhost%3A4000%2Flinux%2F2017%2F08%2F05%2FSPI-Support-embedded-box.html"
        onclick="window.open(this.href, 'linkedin-share', 'width=550,height=255');return false;">
        <i class="fa fa-linkedin-square fa-lg"></i>
      </a>
    
    
    
    
  
</section>




</div>
</div>

    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <h3 class="footer-heading">Wenwei Weng's Blog</h3>

    <div class="site-navigation">

      <p><strong>Site Map</strong></p>
      <ul class="pages">
				
	
	<li class="nav-link"><a href="/about/">About</a>
	

	

	

	
	<li class="nav-link"><a href="/posts/">Posts</a>
	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	


      </ul>
    </div>

    <div class="site-contact">

      <p><strong>Contact</strong></p>
      <ul class="social-media-list">
        <li>
          <a href="mailto:weweng@gmail.com">
            <i class="fa fa-envelope-o"></i>
            <span class="username">weweng@gmail.com</span>
          </a>
        </li>

        
          
          <li>
            <a href="https://github.com/weweng" title="Fork me on GitHub">
              <i class="fa fa-github"></i>
              <span class="username">weweng</span>
            </a>
          </li>
          
        
          
          <li>
            <a href="https://www.linkedin.com/in/wenwei-weng/" title="Connect with me on LinkedIn">
              <i class="fa fa-linkedin"></i>
              <span class="username">Wenwei Weng</span>
            </a>
          </li>
          
        

      </ul>
    </div>

    <div class="site-signature">
      <p class="rss-subscribe text"><strong>Subscribe <a href="/feed.xml">via RSS</a></strong></p>
      <p class="text">A simple yet classy theme for your Jekyll based blog.
</p>
    </div>

  </div>

</footer>

<!-- Scripts -->
<script src="//code.jquery.com/jquery-3.4.1.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/highlight.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.1/js/lightbox.min.js"></script>
<script src="//unpkg.com/popper.js@1"></script>
<script src="//unpkg.com/tippy.js@5"></script>

<script type="text/javascript">
$(document).ready(function() {
  // Default syntax highlighting
  hljs.initHighlightingOnLoad();

  // Header
  var menuToggle = $('#js-mobile-menu').unbind();
  $('#js-navigation-menu').removeClass("show");
  menuToggle.on('click', function(e) {
    e.preventDefault();
    $('#js-navigation-menu').slideToggle(function(){
      if($('#js-navigation-menu').is(':hidden')) {
        $('#js-navigation-menu').removeAttr('style');
      }
    });
  });

	// Enable tooltips via Tippy.js
	if (Array.isArray(window.tooltips)) {
		window.tooltips.forEach(function(tooltip) {
			var selector = tooltip[0];
			var config = tooltip[1];
			tippy(selector, config);
		})
	}
});

</script>






  </body>

</html>
